#include <stdlib.h>
#include <string.h>
#include <stdio.h>
#include <unistd.h>
#include <sys/socket.h>
#include <sys/wait.h>
#include <arpa/inet.h>

int main(int argc, char **argvf, char **envpf) {

    int sd;
    int ret;
    int pipefd_in[2], pipefd_err[2];
    struct sockaddr_in saddr;
    pid_t pid;
    FILE *fp;
    char *file_name = "\x0a";

    // argv: stage 1
    char *argv[101] = {
        "input", 
        "", "", "", "", "", "", "", "", "", 
        "", "", "", "", "", "", "", "", "", "", 
        "", "", "", "", "", "", "", "", "", "", 
        "", "", "", "", "", "", "", "", "", "", 
        "", "", "", "", "", "", "", "", "", "", 
        "", "", "", "", "", "", "", "", "", "", 
        "", "", "", "", "", 
        "\x00", "\x20\x0a\x0d", "9999", 
        "", "", 
        "", "", "", "", "", "", "", "", "", "", 
        "", "", "", "", "", "", "", "", "", "", 
        "", "", "", "", "", "", "", "", "", "",
        NULL
    };


    // env: stage 2
    char *envp[] = {
        "\xde\xad\xbe\xef=\xca\xfe\xba\xbe",
        NULL
    };

    // file: stage 3
    fp = fopen(file_name, "w");
    if(!fp) {
        perror("file error");
        exit(-1);
    }
    fwrite("\x00\x00\x00\x00", 4, 1, fp);
    fclose(fp);

    ret = pipe(pipefd_in);
    ret = pipe(pipefd_err);
    pid = fork();

    if (pid == 0) {
        dup2(pipefd_in[0], 0);
        dup2(pipefd_err[0], 2);

        close(pipefd_in[1]);
        close(pipefd_err[1]);

        execve("input", argv, envp);
    } else if (pid > 0) {
        // stdio
        write(pipefd_in[1], "\x00\x0a\x00\xff", 4);
        write(pipefd_err[1], "\x00\x0a\x02\xff", 4);

        // network
        sd = socket(AF_INET, SOCK_STREAM, 0);
        if(sd == -1) {
            perror("socket Error");
            exit(-1);
        }
        saddr.sin_family = AF_INET;
        saddr.sin_addr.s_addr = INADDR_ANY;
        saddr.sin_port = htons(atoi(argv['C']));

        sleep(1);
        ret = connect(sd, 
                (struct sockaddr *) &saddr, 
                (socklen_t)sizeof(struct sockaddr_in));

        if (ret == -1) {
            perror("Connect error");
            exit(-1);
        }

        send(sd, "\xde\xad\xbe\xef", 4, 0);
        close(sd);

        wait(&ret);

    } else {
        perror("fork error");
        exit(-1);
    }
    remove(file_name);

    return 0;
}
